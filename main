import flet as ft
import colorsys

# === é¢œè‰²é…ç½® ===
COLOR_BG = "#1A1A1A"
COLOR_CARD = "#252525"
COLOR_TEXT = "#E0E0E0"
COLOR_GOLD = "#F5C342"
COLOR_RED = "#FF4C4C"
COLOR_GREEN = "#00FF7F"

def main(page: ft.Page):
    # 1. æ‰‹æœºç«¯é¡µé¢é…ç½®
    page.title = "1999 è§‚æµ‹è®°å½•"
    page.theme_mode = ft.ThemeMode.DARK
    page.bgcolor = COLOR_BG
    page.padding = 10
    # å…è®¸æ»šåŠ¨ï¼Œé˜²æ­¢é”®ç›˜é®æŒ¡
    page.scroll = ft.ScrollMode.ADAPTIVE

    # === æ•°æ®é€»è¾‘ ===
    # ä»æ‰‹æœºæœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
    def load_data():
        if page.client_storage.contains_key("records"):
            return page.client_storage.get("records")
        return []

    def save_data():
        page.client_storage.set("records", records)

    records = load_data()

    # === å·¥å…·å‡½æ•° ===
    def get_color(pulls):
        limit = 70.0
        p = min(max(pulls, 0), limit)
        hue = 0.35 * (1 - (p / limit))
        r, g, b = colorsys.hsv_to_rgb(hue, 0.85, 0.95)
        return f"#{int(r*255):02x}{int(g*255):02x}{int(b*255):02x}"

    def get_rank(pulls):
        if pulls <= 20: return "SSS"
        if pulls <= 40: return "S"
        if pulls <= 50: return "A"
        if pulls <= 60: return "B"
        return "C"

    # === UI ç»„ä»¶ ===
    
    # 1. é¡¶éƒ¨è¾“å…¥å¡ç‰‡
    pool_dd = ft.Dropdown(
        options=[ft.dropdown.Option(x) for x in ["æ´»åŠ¨æ± ", "é™å®šæ± ", "ç‰¹æ®Šæ± ", "é‡‘çººæ± "]],
        value="æ´»åŠ¨æ± ",
        label="å¡æ± ",
        width=100,
        text_size=14,
        content_padding=10
    )
    
    char_tf = ft.TextField(label="è§’è‰²å", expand=True, height=50, text_size=14)
    pulls_tf = ft.TextField(label="æŠ½æ•°", keyboard_type=ft.KeyboardType.NUMBER, width=80, height=50, text_size=14)
    lost_sw = ft.Switch(label="æ­ªäº†", active_color=COLOR_RED)

    def add_click(e):
        if not char_tf.value or not pulls_tf.value:
            page.show_snack_bar(ft.SnackBar(ft.Text("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯")))
            return
        
        try:
            p_val = int(pulls_tf.value)
        except: return

        pool = pool_dd.value
        is_guaranteed = pool in ["ç‰¹æ®Šæ± ", "é‡‘çººæ± "]
        is_lost = False if is_guaranteed else lost_sw.value

        records.append({
            "pool": pool, 
            "character": char_tf.value, 
            "pulls": p_val, 
            "is_lost": is_lost
        })
        save_data()
        
        char_tf.value = ""
        pulls_tf.value = ""
        render_list()
        page.update()

    input_card = ft.Container(
        bgcolor=COLOR_CARD,
        padding=15,
        border_radius=10,
        content=ft.Column([
            ft.Row([ft.Text("ğŸ“ æ–°å¢è®°å½•", size=16, weight="bold")]),
            ft.Row([pool_dd, char_tf]),
            ft.Row([
                pulls_tf, 
                lost_sw, 
                ft.ElevatedButton("è®°å½•", on_click=add_click, bgcolor=COLOR_GOLD, color="black", expand=True)
            ], alignment=ft.MainAxisAlignment.SPACE_BETWEEN)
        ])
    )

    # 2. ç»Ÿè®¡ä¸åˆ—è¡¨
    chart_col = ft.Column(spacing=10)
    
    stats_text = ft.Text("æš‚æ— æ•°æ®", size=12, color="grey")
    
    tabs = ft.Tabs(
        selected_index=0,
        tabs=[ft.Tab(text=n) for n in ["æ´»åŠ¨", "é™å®š", "ç‰¹æ®Š", "é‡‘çºº"]],
        on_change=lambda e: render_list()
    )

    def render_list():
        chart_col.controls.clear()
        
        # ç­›é€‰
        filter_keys = ["æ´»åŠ¨", "é™å®š", "ç‰¹æ®Š", "é‡‘çºº"]
        current_key = filter_keys[tabs.selected_index]
        
        # å€’åºæ˜¾ç¤º
        data = [r for r in reversed(records) if current_key in r['pool']]
        
        # æ›´æ–°ç»Ÿè®¡ç®€æŠ¥
        if data:
            total_p = sum(r['pulls'] for r in data)
            avg = total_p / len(data)
            lost_c = sum(1 for r in data if r['is_lost'])
            stats_text.value = f"å¹³å‡: {avg:.1f}æŠ½ | æ€»è®¡: {len(data)}é‡‘"
            if current_key not in ["ç‰¹æ®Š", "é‡‘çºº"]:
                stats_text.value += f" | æ­ª: {lost_c}æ¬¡"
        else:
            stats_text.value = "è¯¥å¡æ± æš‚æ— è®°å½•"

        # æ¸²æŸ“åˆ—è¡¨
        for r in data:
            pulls = r['pulls']
            color = get_bar_color(pulls)
            rank = get_rank(pulls)
            
            # æ ‡è®°ç¬¦å·
            badge = ""
            badge_col = "grey"
            if r.get('is_lost'): 
                badge = "LOST"
                badge_col = COLOR_RED
            elif current_key in ["æ´»åŠ¨", "é™å®š"]:
                badge = "WIN"
                badge_col = COLOR_GOLD

            # è¿›åº¦æ¡é•¿åº¦ (ç™¾åˆ†æ¯”)
            bar_pct = min(pulls / 70.0, 1.0)
            
            # å•ä¸ªå¡ç‰‡
            item = ft.Container(
                bgcolor=COLOR_CARD,
                padding=12,
                border_radius=8,
                content=ft.Column([
                    # ç¬¬ä¸€è¡Œï¼šåå­— + è¯„çº§
                    ft.Row([
                        ft.Text(r['character'], weight="bold", size=15),
                        ft.Container(expand=True),
                        ft.Text(badge, color=badge_col, size=12, weight="bold"),
                        ft.Container(width=5),
                        ft.Text(rank, color=color, weight="bold", size=16),
                    ]),
                    # ç¬¬äºŒè¡Œï¼šè¿›åº¦æ¡
                    ft.Stack([
                        ft.Container(height=16, border_radius=8, bgcolor="#333", width=1000), # åº•æ§½
                        ft.Container(
                            height=16, 
                            border_radius=8, 
                            bgcolor=color,
                            # ä½¿ç”¨ animate å®ç°ç®€å•çš„å®½åº¦åŠ¨ç”»æ•ˆæœéœ€è¦ç»“åˆ width
                            # è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œç›´æ¥ç”¨ Row + expand æ¨¡æ‹Ÿæ¯”ä¾‹
                        )
                    ]),
                    # ä¸ºäº†å®ç°ç²¾ç¡®çš„ç™¾åˆ†æ¯”å®½åº¦ï¼Œæˆ‘ä»¬ç”¨ Row åµŒå¥—
                    ft.Row([
                        ft.Container(height=8, border_radius=4, bgcolor=color, expand=int(bar_pct*100)),
                        ft.Container(expand=int((1-bar_pct)*100) + 1)
                    ], spacing=0),
                    
                    # æŠ½æ•°æ–‡å­—
                    ft.Row([
                        ft.Text(f"{pulls} æŠ½", size=12, color="white"),
                    ], alignment=ft.MainAxisAlignment.END)
                ], spacing=5)
            )
            chart_col.controls.append(item)
        
        page.update()

    # 3. é¡µé¢ç»„è£…
    page.add(
        input_card,
        ft.Container(height=10),
        ft.Text("ğŸ“Š å†å²è®°å½•", weight="bold", size=16),
        tabs,
        ft.Container(content=stats_text, padding=ft.padding.only(bottom=10)),
        chart_col
    )
    
    render_list()

ft.app(target=main)